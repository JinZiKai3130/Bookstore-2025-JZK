# 总体设计文档

## BookStore 2025
**项目名称** 书店管理系统
**作者** 金子凯

## 概述
本项目依据相关规范，设计并开发了一个功能齐全的书店管理系统。系统包含账户管理、图书管理、销售管理与日志系统等模块，可全面支持书店的日常运营需求。程序可将数据持久化保存至文件中，确保数据的连续存储与读取。在初次启动时，系统将自动进行初始化，并创建一个具备超级管理员权限的默认账户（root）。

## 总体实现逻辑

### 操作对象
- **账户**： 使用一个栈结构来维护当前的登录状态，栈中存储当前的`UserID`，当前权限为栈顶`UserID`对应的权限。

- **书**： 用一个结构体来确认当前选择的这本书，并在此基础之上进行修改等操作。

- **日志**： 以`time`为key，存储在文件中。每次操作结束，进行写入，出现查询需求也做出相应的反应。

### 模块设计
主要分为三个部分：命令解析模块（表示层）、账户/图书/日志管理模块（业务逻辑层）、数据库（数据访问层）

### 命令解析模块（表示层）
- **功能**：解析用户输入的指令，拆分为关键词和参数，进行格式合法性校验（如字符集、长度限制）
- **核心逻辑**：
  - 去除指令首尾空格，合并连续空格
  - 按空格分割指令为 tokens，第一个 token 为关键词
  - 根据关键词匹配对应的指令格式，校验参数个数和格式（如 `su` 指令需匹配 `[UserID] ([Password])?` 格式）


### 账户管理模块（业务逻辑层）
- **功能**：处理账户的创建、登录、注销、密码修改、删除等操作，维护登录栈和权限控制
- **核心组件**：
  - 登录栈管理：采用栈结构存储嵌套登录的账户信息，支持 `su`（入栈）和 `logout`（出栈）操作
  - 权限控制：校验当前登录账户（栈顶元素）的权限是否满足指令要求（如 `delete` 指令需权限 {7}）
- **核心逻辑**：
  - 账户创建：`register`（权限{1}）、`useradd`（权限{3}）需检查 UserID 唯一性及权限合法性
  - 登录验证：`su` 指令需验证账户存在性及密码（高权限账户可省略密码）
  - 密码修改：`passwd` 指令需验证当前密码（高权限账户可省略）


### 图书管理模块（业务逻辑层）
- **功能**：处理图书的查询、购买、选择、修改、进货等操作，维护图书信息和库存
- **核心逻辑**：
  - 图书查询：`show` 指令支持按 ISBN、名称、作者、关键词检索，结果按 ISBN 升序排序
  - 图书购买：`buy` 指令需检查库存，扣减数量并记录财务收入
  - 图书修改：`modify` 指令需基于选中的图书，校验参数合法性（如 ISBN 不可重复、关键词无重复段）
  - 图书进货：`import` 指令增加库存，记录财务支出


### 日志管理模块（业务逻辑层）
- **功能**：记录财务交易和系统操作日志，支持日志查询和报告生成
- **核心组件**：
  - 财务日志：记录每笔交易（购买收入、进货支出）的金额和时间
  - 操作日志：记录用户执行的指令及相关信息（用户ID、操作类型、时间）
- **核心逻辑**：
  - 财务查询：`show finance` 指令按指定笔数输出收入和支出总和
  - 报告生成：`report finance`、`report employee`、`log` 指令按自定义格式生成报告


### 数据存储模块（数据访问层）
- **功能**：管理文件存储，提供数据读写接口，确保数据持久化
- **文件设计**（不超过20个文件）：
  - `users.dat`：存储账户信息（UserID、密码（加密存储）、权限、用户名）
  - `books.dat`：存储图书信息（ISBN、名称、作者、关键词、价格、库存）
  - `finance.log`：存储财务交易记录（类型、金额、时间）
  - `operation.log`：存储系统操作日志（用户ID、指令、时间）
- **读写策略**：实时读写文件，避免数据驻留内存；通过索引（如 ISBN 映射文件偏移量）优化查询效率

## 数据结构设计

### 账户数据结构

用一个结构体来存储一个用户的各种功能
```
struct User {
    std::string user_id;
    std::string password;
    std::string username;
    int privilege;
};
```

### 图书数据结构
```
struct Book {
    std::string ISBN;
    std::string bookname;
    std::string author;
    std::vector<std::string> keywords;
    double price;
    int quantity;
};
```

### 日志

交易记录
```
struct FinanceRecord {
    double amount;
    time_t timestamp;
};
```

操作记录
```
struct OperationRecord {
    string user_id;
    string command;
    time_t timestamp;
};
```

## 接口设计

### shell命令行指令
通过`main.cpp`，使用`cin`和`cout`输入输出

### 模块间接口
#### 表示层$\rightarrow$业务逻辑层
`bool execute(const string& command, string& output)`
通过这个指令将语句执行相应的command

#### 业务逻辑层$\rightarrow$数据访问层
主要有这些函数来实现书店的功能
- **账号**：
```
void addUser(const std::string& user_id,
             const std::string& username,
             const std::string& password,
             int privilege);

void Delete(const std::string& user_id);

User getUser(const std::string& user_id);

void changePassword(const std::string& user_id,
                    const std::string& username, 
                    const std::string& password);

void Login(const string& username, const string& password);

void Logout();
```

- **图书**：
```
bool purchaseBook(const std::string& isbn, 
                  int quantity, 
                  double& total_cost);
bool importBook(const std::string& isbn, 
                int quantity, 
                double total_cost);
bool createBook(const Book& book);
bool updateBook(const std::string& old_isbn, 
                const Book& new_book);
bool modifyBookInfo(const std::string& isbn, 
                    const std::map<std::string, std::string>& changes);
```

- **日志**：
```
void addLog(const std::string& user_id, const std::string& op);

void printLog();

void reportEmployee();

void reportFinance();

void readFinance(int count);

void writeFinance(int type, double finance);
```

